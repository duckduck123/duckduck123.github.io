<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>zookeeper选举算法源码分析 | misterge Blog</title>
  <meta name="author" content="Mister Ge">
  
  <meta name="description" content="This class has been deprecated as of release 3.4.0选举类public class LeaderElection implements Election  {

    private static final Logger LOG = 

    L">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="zookeeper选举算法源码分析"/>
  <meta property="og:site_name" content="misterge Blog"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="misterge Blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">misterge Blog</a></h1>
  <h2><a href="/">煎熬与批评都是成就非凡的先决条件</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-01-11T17:42:25.000Z"><a href="/2017/01/12/github-pages-个人博客/">2017-01-12</a></time>
      
      
  
    <h1 class="title">zookeeper选举算法源码分析</h1>
  

    </header>
    <div class="entry">
      
        <h2 id="This-class-has-been-deprecated-as-of-release-3-4-0"><a href="#This-class-has-been-deprecated-as-of-release-3-4-0" class="headerlink" title="This class has been deprecated as of release 3.4.0"></a>This class has been deprecated as of release 3.4.0</h2><h2 id="选举类"><a href="#选举类" class="headerlink" title="选举类"></a>选举类</h2><pre><code>public class LeaderElection implements Election  {

    private static final Logger LOG = 

    LoggerFactory.getLogger(LeaderElection.class);

    protected static final Random epochGen = new

    Random();

    protected QuorumPeer self;

    public LeaderElection(QuorumPeer self) {
        this.self = self;
    }
    protected static class ElectionResult {
        public Vote vote;
        /**
         * vote 统计次数
         */
        public int count;
        /**
         * 获胜者选票
         */
        public Vote winner;
        /**
         * 获胜票count值
         */
        public int winningCount;
        /**
         * 有效选票总值
         */
        public int numValidVotes;
    }
    //处理投票
    protected ElectionResult countVotes(HashMap&lt;InetSocketAddress, Vote&gt; votes, HashSet&lt;Long&gt; heardFrom) {
        final ElectionResult result = new ElectionResult();
        // Initialize with null vote
        result.vote = new Vote(Long.MIN_VALUE, Long.MIN_VALUE);
        result.winner = new Vote(Long.MIN_VALUE, Long.MIN_VALUE);

        // First, filter out votes from unheard-from machines. Then
        // make the views consistent. Sometimes peers will have
        // different zxids for a server depending on timing.
        final HashMap&lt;InetSocketAddress, Vote&gt; validVotes = new HashMap&lt;InetSocketAddress, Vote&gt;();
        final Map&lt;Long, Long&gt; maxZxids = new HashMap&lt;Long,Long&gt;();
        for (Map.Entry&lt;InetSocketAddress, Vote&gt; e : votes.entrySet()) {
            // Only include votes from machines that we heard from
            final Vote v = e.getValue();
            if (heardFrom.contains(v.getId())) {
                validVotes.put(e.getKey(), v);
                Long val = maxZxids.get(v.getId());
                if (val == null || val &lt; v.getZxid()) {
                    maxZxids.put(v.getId(), v.getZxid());
            }
                    }
                }

        // Make all zxids for a given vote id equal to the largest zxid seen for
        // that id
        for (Map.Entry&lt;InetSocketAddress, Vote&gt; e : validVotes.entrySet()) {
            final Vote v = e.getValue();
            Long zxid = maxZxids.get(v.getId());
            if (v.getZxid() &lt; zxid) {
                // This is safe inside an iterator as per
                // http://download.oracle.com/javase/1.5.0/docs/api/java/util/Map.Entry.html
                e.setValue(new Vote(v.getId(), zxid, v.getElectionEpoch(), v.getPeerEpoch(), v.getState()));
            }
        }
        /*有效票总数*/
        result.numValidVotes = validVotes.size();

        final HashMap&lt;Vote, Integer&gt; countTable = new HashMap&lt;Vote, Integer&gt;();
        // Now do the tally
        for (Vote v : validVotes.values()) {
            Integer count = countTable.get(v);
            if (count == null) {
                count = 0;
            }
            /**/
            countTable.put(v, count + 1);
            if (v.getId() == result.vote.getId()) {
                result.count++;
            } else if (v.getZxid() &gt; result.vote.getZxid()
                    || (v.getZxid() == result.vote.getZxid() &amp;&amp; v.getId() &gt; result.vote.getId())) {
                result.vote = v;
                result.count = 1;
                /*如果当前票的zxid大于选举结果票的zxid 则把当前票赋值为选举结果票，然后count=1*/
            }
        }
        result.winningCount = 0;
        LOG.info(&quot;Election tally: &quot;);
        /*选举计数器*/
        for (Entry&lt;Vote, Integer&gt; entry : countTable.entrySet()) {
            if (entry.getValue() &gt; result.winningCount) {
                result.winningCount = entry.getValue();
                result.winner = entry.getKey();
            }
            LOG.info(entry.getKey().getId() + &quot;\t-&gt; &quot; + entry.getValue());
        }
        return result;
    }

    /**
     * There is nothing to shutdown in this implementation of
     * leader election, so we simply have an empty method.
     */
    public void shutdown(){}

    /**
     * Invoked in QuorumPeer to find or elect a new leader.
     * 
     * @throws InterruptedException
     */
    //主要选举方法
    public Vote lookForLeader() throws InterruptedException {
        try {
            self.jmxLeaderElectionBean = new LeaderElectionBean();
            MBeanRegistry.getInstance().register(
                    self.jmxLeaderElectionBean, self.jmxLocalPeerBean);
        } catch (Exception e) {
            LOG.warn(&quot;Failed to register with JMX&quot;, e);
            self.jmxLeaderElectionBean = null;
        }

        try {
            self.setCurrentVote(new Vote(self.getId(),
                    self.getLastLoggedZxid()));
            // We are going to look for a leader by casting a vote for ourself
            byte requestBytes[] = new byte[4];
            ByteBuffer requestBuffer = ByteBuffer.wrap(requestBytes);
            byte responseBytes[] = new byte[28];
            /* ByteBuffer.wrap(responseBytes) 将 responseBytes 数组包装到缓冲区中*/
            ByteBuffer responseBuffer = ByteBuffer.wrap(responseBytes);
            /* The current vote for the leader. Initially me! */
            /* 当前为领袖投票。最初的我*/
            /* DatagramSocket代表UDP协议的Socket
             * DatagramSocket本身只是码头，不维护状态，不能产生IO流，它的唯一作用就是接收和发送数据报*/
            DatagramSocket s = null;
            try {
                /*创建一个DatagramSocket实例，并将该对象绑定到本机默认IP地址、本机所有可用端口中随机选择的某个端口*/
                s = new DatagramSocket();
                s.setSoTimeout(200);
            } catch (SocketException e1) {
                LOG.error(&quot;Socket exception when creating socket for leader election&quot;, e1);
                System.exit(4);
            }
            /*DatagramPacket来代表数据报，
             *DatagramSocket接收和发送的数据都是通过DatagramPacket对象完成
             *发送数据包4个字节的数据报*/
            DatagramPacket requestPacket = new DatagramPacket(requestBytes,
                    requestBytes.length);
            /*接收28个字节的数据报*/
            DatagramPacket responsePacket = new DatagramPacket(responseBytes,
                    responseBytes.length);
            /*Random 随机获取一个int值*/
            int xid = epochGen.nextInt();
            while (self.isRunning()) {
                /*InetSocketAddress 此类实现 IP 套接字地址（IP 地址 + 端口号），不依赖任何协议
                 *Vote 投票实体
                     *version 版本
                     *id
                     *electionEpoch 用来标记leader选举的轮次
                     *peerEpoch 用来标记事务请求所属的轮次
                     *zxid     事务请求的唯一标记，由leader服务器负责进行分配。
                             *由2部分构成，高32位是上述的peerEpoch，低32位是请求的计数，从0开始。
                             *所以由zxid我们就可以知道该请求是哪个轮次的，并且是该轮次的第几个请求。
                     *state 状态
                     *key 远程主机地址， value 远程主机的投票 */
                HashMap&lt;InetSocketAddress, Vote&gt; votes =
                    new HashMap&lt;InetSocketAddress, Vote&gt;(self.getVotingView().size());

                requestBuffer.clear();
                /*将 4 个包含给定 int 值的字节按照当前的字节顺序写入到此缓冲区的当前位置，然后将该位置增加 4。*/
                requestBuffer.putInt(xid);
                requestPacket.setLength(4);
                HashSet&lt;Long&gt; heardFrom = new HashSet&lt;Long&gt;();
                for (QuorumServer server : self.getVotingView().values()) {
                    LOG.info(&quot;Server address: &quot; + server.addr);
                    try {
                        /*设置要将此数据报发往的远程主机的 SocketAddress（通常为 IP 地址 + 端口号）*/
                        requestPacket.setSocketAddress(server.addr);
                    } catch (IllegalArgumentException e) {
                        // Sun doesn&apos;t include the address that causes this
                        // exception to be thrown, so we wrap the exception
                        // in order to capture this critical detail.
                        throw new IllegalArgumentException(
                                &quot;Unable to set socket address on packet, msg:&quot;
                                + e.getMessage() + &quot; with addr:&quot; + server.addr,
                                e);
                    }

                    try {
                        /*发送数据报*/
                        s.send(requestPacket);
                        /*设置要接收的数据报的长度*/
                        responsePacket.setLength(responseBytes.length);
                        /*接收数据报*/
                        s.receive(responsePacket);
                        if (responsePacket.getLength() != responseBytes.length) {
                            LOG.error(&quot;Got a short response: &quot;
                                    + responsePacket.getLength());
                            /*如果接收到的数据报长度不等于28个字节则continue*/
                            continue;
                        }
                        responseBuffer.clear();
                        /*读取此缓冲区的当前位置之后的 4 个字节，根据当前的字节顺序将它们组成 int 值，然后将该位置增加 4。*/
                        int recvedXid = responseBuffer.getInt();
                        if (recvedXid != xid) {
                            LOG.error(&quot;Got bad xid: expected &quot; + xid
                                    + &quot; got &quot; + recvedXid);
                            continue;
                        }
                        long peerId = responseBuffer.getLong();
                        heardFrom.add(peerId);
                        //if(server.id != peerId){
                            Vote vote = new Vote(responseBuffer.getLong(),
                                responseBuffer.getLong());
                            InetSocketAddress addr =
                                (InetSocketAddress) responsePacket
                                .getSocketAddress();
                            /*存入有反馈的服务地址和投票信息 */
                            votes.put(addr, vote);
                        //}
                    } catch (IOException e) {
                        LOG.warn(&quot;Ignoring exception while looking for leader&quot;,
                                e);
                        // Errors are okay, since hosts may be
                        // down
                    }
                }
                /*投票结果*/
                ElectionResult result = countVotes(votes, heardFrom);
                // ZOOKEEPER-569:
                // If no votes are received for live peers, reset to voting 
                // for ourselves as otherwise we may hang on to a vote 
                // for a dead peer             
                /*如果没有收到有效投票票,重置为自己投票*/
                if (result.numValidVotes == 0) {
                    self.setCurrentVote(new Vote(self.getId(),
                            self.getLastLoggedZxid()));
                } else {
                    /*如果获胜者id大于0则继续*/
                    if (result.winner.getId() &gt;= 0) {
                        /*把获胜者的票设置为自己的票*/
                        self.setCurrentVote(result.vote);
                        // To do: this doesn&apos;t use a quorum verifier
                        /*如果投票数已经过半 */
                        if (result.winningCount &gt; (self.getVotingView().size() / 2)) {
                            self.setCurrentVote(result.winner);
                            s.close();
                            Vote current = self.getCurrentVote();
                            LOG.info(&quot;Found leader: my type is: &quot; + self.getLearnerType());
                            /*
                             * We want to make sure we implement the state machine
                             * correctly. If we are a PARTICIPANT, once a leader
                             * is elected we can move either to LEADING or 
                             * FOLLOWING. However if we are an OBSERVER, it is an
                             * error to be elected as a Leader.
                             */
                            if (self.getLearnerType() == LearnerType.OBSERVER) {
                                /*如果自己是观察并且获胜者票id等于自己票id
                                 *这种情况永远不会发生，因为观察者不参与投票*/
                                if (current.getId() == self.getId()) {
                                    // This should never happen!
                                    LOG.error(&quot;OBSERVER elected as leader!&quot;);
                                    Thread.sleep(100);
                                }
                                else {
                                    /*则设置自己状态为观察ing*/
                                    self.setPeerState(ServerState.OBSERVING);
                                    Thread.sleep(100);
                                    return current;
                                }
                            } else {
                                /*自己非观察者
                                 * 如果获胜票id等于自己id也就说明自己的票最终获胜自己当选领导者
                                 * 如果获胜者的票id不等于自己id，则说明不是自己获胜自己则成为跟随者*/
                                self.setPeerState((current.getId() == self.getId())
                                        ? ServerState.LEADING: ServerState.FOLLOWING);
                                if (self.getPeerState() == ServerState.FOLLOWING) {
                                    Thread.sleep(100);
                                }                            
                                return current;
                            }
                        }
                    }
                }
                Thread.sleep(1000);
            }
            return null;
        } finally {
            try {
                if(self.jmxLeaderElectionBean != null){
                    MBeanRegistry.getInstance().unregister(
                            self.jmxLeaderElectionBean);
                }
            } catch (Exception e) {
                LOG.warn(&quot;Failed to unregister with JMX&quot;, e);
            }
            self.jmxLeaderElectionBean = null;
        }
    }
</code></pre><p>}</p>

      
    </div>
    <footer>
      
        
        
  
  <div class="tags">
    <a href="/tags/zookeeper/">zookeeper</a>
  </div>

        
  <div class="addthis addthis_toolbox addthis_default_style">
    
      <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
    
    
      <a class="addthis_button_tweet"></a>
    
    
      <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    
    
      <a class="addthis_button_pinterest_pinit" pi:pinit:layout="horizontal"></a>
    
    <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js"></script>

      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
  <h1 class="title">Kommentare</h1>

  
      <div id="fb-root"></div>
<script>
  (function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=123456789012345";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));
</script>

<div class="fb-comments" data-href="http://www.geyangyang.com/2017/01/12/github-pages-个人博客/index.html" data-num-posts="5" data-width="840" data-colorscheme="light"></div>
      
  
</section>

</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Suche">
    <input type="hidden" name="q" value="site:www.geyangyang.com">
  </form>
</div>

  

  
<div class="widget tag">
  <h3 class="title">Tags</h3>
  <ul class="entry">
  
    <li><a href="/tags/Hexo/">Hexo</a><small>1</small></li>
  
    <li><a href="/tags/zookeeper/">zookeeper</a><small>1</small></li>
  
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2017 Mister Ge
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>
